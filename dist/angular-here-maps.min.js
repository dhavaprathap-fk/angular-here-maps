"use strict";angular.module("angular-here-maps",[]),angular.module("angular-here-maps").directive("map",function(MapConfig,$document,$compile){return{template:'<div class="here-map"><div ng-transclude></div></div>',restrict:"EA",transclude:!0,replace:!0,controller:function($scope,$element,$attrs){var defaultLayers,modules,ui,behavior,marker,markerWindow;$scope.zoom=$scope.helpers.useDotNotation($scope,$attrs.zoom),$scope.center=$scope.helpers.useDotNotation($scope,$attrs.center),MapConfig.libraries()&&(modules=MapConfig.libraries().split(",")),$scope.refreshMarkers=function(){var mapIcons=$document.find("marker-icon");_.each(mapIcons,function(mapIcon){$compile(mapIcon)($scope)}),$scope.$apply()};var platform=new H.service.Platform({app_id:MapConfig.appId(),app_code:MapConfig.appCode()});defaultLayers=platform.createDefaultLayers(512,MapConfig.pixelPerInch()),this.map=new H.Map($element[0],defaultLayers.normal.map,{pixelRatio:MapConfig.pixelRatio()}),this.ui=H.ui.UI.createDefault(this.map,defaultLayers),$scope.zoom&&this.map.setZoom($scope.zoom),$scope.center&&this.map.setCenter($scope.center),window.addEventListener("resize",function(){this.map.getViewPort().resize()}.bind(this)),_.each(modules,function(module){"ui"===module&&(ui=H.ui.UI.createDefault(this.map,defaultLayers)),"pano"===module&&platform.configure(H.map.render.panorama.RenderEngine),"mapevents"===module&&(behavior=new H.mapevents.Behavior(new H.mapevents.MapEvents(this.map)))}.bind(this));var createMapMarker=function(coordinates,icon){var markerTemplate="<marker-icon><div>"+icon.template+"</div></marker-icon>",markerIcon=new H.map.DomIcon(markerTemplate);marker="html"===icon.type?new H.map.DomMarker(coordinates,{icon:markerIcon}):new H.map.Marker(coordinates)},createMarkerEvents=function(windowTemplate,group,coordinates){group.addEventListener("tap",function(){markerWindow&&this.ui.removeBubble(markerWindow);var newTemplate=windowTemplate;newTemplate=$compile(newTemplate)($scope),$scope.$apply(),markerWindow=new H.ui.InfoBubble(coordinates,{content:newTemplate[0]}),this.ui.addBubble(markerWindow)}.bind(this,coordinates),!1)}.bind(this),createMarkerWindows=function(group,coordinates,icon){if(icon.window){var windowTemplate="<marker-window><div>"+icon.window.template+"</div></marker-window>";createMarkerEvents(windowTemplate,group,coordinates)}},getCurrentIcon=function(defaultIcon,currentIcon){var icon=defaultIcon;return currentIcon&&(currentIcon.type||(icon.type=null,currentIcon.window&&(icon.window=currentIcon.window)),"html"===currentIcon.type&&(icon=currentIcon)),icon};this.addMarkerToMap=function(coordinates,defaultIcon,currentIcon){var group=new H.map.Group,icon=getCurrentIcon(defaultIcon,currentIcon);icon&&(createMapMarker(coordinates,icon),createMarkerWindows(group,coordinates,icon)),this.map.addObject(group),group.addObject(marker)},this.map.addEventListener("mapviewchangeend",function(){$scope.refreshMarkers()})}}}),angular.module("angular-here-maps").directive("marker",function(){return{require:"^map",scope:{coordinates:"=",icon:"="},restrict:"E",link:function(scope,element,attrs,mapController){var addMarker=function(){scope.coordinates&&mapController.addMarkerToMap(scope.coordinates,scope.icon)};scope.$watch("coordinates",function(){addMarker()})}}}),angular.module("angular-here-maps").directive("markers",function(){return{restrict:"E",require:"^map",scope:{locations:"=",icon:"="},link:function(scope,element,attrs,mapController){_.each(scope.locations,function(location){mapController.addMarkerToMap(location.coordinates,scope.icon,location.icon)})}}}),angular.module("angular-here-maps").run(function($rootScope){$rootScope.helpers={useDotNotation:function(object,path){path=String(path).split(".");for(var i=0;i<path.length;i++)object=object[path[i]];return object}}}),angular.module("angular-here-maps").provider("MapConfig",function(){this.mapOptions={},this.$get=function(){var mapOptions=this.mapOptions;return{appId:function(appId){return mapOptions.appId||appId},appCode:function(appCode){return mapOptions.appCode||appCode},pixelRatio:function(ratio){return mapOptions.pixelRatio||ratio},pixelPerInch:function(pixel){return mapOptions.pixelPerInch||pixel},libraries:function(libraries){return mapOptions.libraries||libraries}}},this.setOptions=function(options){this.mapOptions=options}});